<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TikTok Battle Mobile</title>
    <style>
        /* === ESTILOS CSS === */
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            background: #000; overflow: hidden; touch-action: none; 
            font-family: 'Arial Black', sans-serif;
        }

        body {
            background: #000 url('fondo-juego.png') no-repeat center center fixed;
            background-size: cover;
        }

        #game-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            z-index: 1;
        }

        /* Canvas Fullscreen */
        canvas { width: 100% !important; height: 100% !important; object-fit: fill; }
        
        /* === MARCADOR === */
        #score-board {
            position: absolute; top: 8%; left: 0; width: 100%;
            display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box;
            z-index: 20; pointer-events: none;
            text-shadow: 3px 3px 0 #000;
        }
        .score-box { text-align: center; transform: scale(1.1); } 
        .score-num { font-size: 35px; color: white; display: block; line-height: 1; font-weight: 900; }
        .score-label { font-size: 10px; color: #ddd; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; }
        
        /* Timer */
        #ui-layer { position: absolute; top: 3%; left: 0; width: 100%; pointer-events: none; text-align: center; z-index: 20; }
        .timer { color: white; font-size: 45px; font-weight: 900; text-shadow: 3px 3px 0 #000; letter-spacing: 2px; }
        
        /* Pantalla Victoria */
        .winner-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9);
            display: none; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 999; backdrop-filter: blur(8px);
        }
        .winner-title { 
            font-size: 50px; margin-bottom: 20px; text-align: center; color: white; 
            animation: pulse 0.5s infinite; text-transform: uppercase;
            -webkit-text-stroke: 2px black;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        /* MVP Estilizado */
        .mvp-box { 
            width: 85%; background: rgba(30,30,30,0.8); 
            border-radius: 15px; padding: 20px; 
            border: 3px solid #fff; box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        .mvp-row { 
            display: flex; justify-content: space-between; color: white; font-size: 18px; 
            padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); 
        }
        .mvp-row:last-child { border-bottom: none; }
        .mvp-row:first-child { color: #ffd700; font-size: 22px; text-shadow: 0 0 10px #ffd700; } 

        .win-angel h1 { text-shadow: 0 0 50px #ffd700; color: #ffd700; }
        .win-angel .mvp-box { border-color: #ffd700; }
        .win-demon h1 { text-shadow: 0 0 50px #ff3300; color: #ff3300; }
        .win-demon .mvp-box { border-color: #ff3300; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

    <div id="score-board">
        <div class="score-box">
            <span class="score-num" id="scoreAngel" style="color:#ffd700">0</span>
            <span class="score-label">ANGELS</span>
        </div>
        <div class="score-box">
            <span class="score-num" id="scoreDemon" style="color:#ff3300">0</span>
            <span class="score-label">DEMONS</span>
        </div>
    </div>

    <div id="ui-layer">
        <div class="timer" id="timerText">240</div>
        <div style="color: lime; font-size: 12px; font-weight:bold;" id="statusText">CONECTANDO...</div>
    </div>

    <div id="game-container"></div>

    <div id="winner-screen" class="winner-screen">
        <h1 id="winnerText" class="winner-title">GANADOR</h1>
        <div class="mvp-box">
            <div style="color:white; text-align:center; font-weight:900; margin-bottom:15px; letter-spacing:3px;">游녬 TOP MVP 游녬</div>
            <div id="mvpList"></div>
        </div>
        <div style="margin-top: 30px; color:#aaa; font-size: 16px;">Pr칩xima batalla en:</div>
        <span id="restartCount" class="restart-count" style="font-size: 40px; color: white; font-weight: bold;">10</span>
    </div>

    <script>
        // HACK ANTI-ANUNCIOS
        setInterval(() => {
            const allowedIds = ['ui-layer', 'game-container', 'winner-screen', 'score-board'];
            for (let i = 0; i < document.body.children.length; i++) {
                const el = document.body.children[i];
                if (el.tagName !== 'SCRIPT' && !allowedIds.includes(el.id)) el.style.display = 'none';
            }
        }, 1000);

        const CONFIG = {
            type: Phaser.AUTO,
            scale: { mode: Phaser.Scale.resize, width: '100%', height: '100%', parent: 'game-container' },
            transparent: true,
            scene: { preload: preload, create: create, update: update, resize: resize }
        };

        let game = new Phaser.Game(CONFIG);
        let socket;
        let player;
        let flashRect; // Para el efecto de flash
        let centerX, centerY, gameHeight, gameWidth; 
        let currentPos = 50; 
        let targetY = 0;
        let gameActive = true;
        let timeLeft = 240;
        let usuarios = {}; 
        let totalWinsAngel = 0;
        let totalWinsDemon = 0;

        const COL_ANGEL = 0xffd700;
        const COL_DEMON = 0xff3300; 
        const COL_NEUTRO = 0x0088ff;

        function preload() {
            this.load.image('bg', 'fondo-juego.png');
            this.load.image('flame', 'blue-flame.png');
            this.load.audio('hit', 'hit.mp3');
            this.load.audio('gift', 'gift.mp3');
            this.load.audio('winA', 'win-angel.mp3');
            this.load.audio('winD', 'win-demon.mp3');
        }

        function create() {
            updateDimensions(this);

            // FONDO
            let bgKey = this.textures.exists('bg') ? 'bg' : createFallbackTexture(this, 'bg_fallback', 0x111111);
            this.bg = this.add.image(centerX, centerY, bgKey);
            this.bg.setDisplaySize(Math.max(gameWidth, gameHeight), Math.max(gameWidth, gameHeight));

            // CARRIL
            this.trackBorder = this.add.graphics();
            this.trackFill = this.add.graphics();
            this.trackLine = this.add.rectangle(centerX, centerY, 80, 4, 0xffffff).setAlpha(0.6);

            // JUGADOR (150px)
            let pKey = this.textures.exists('flame') ? 'flame' : createFallbackTexture(this, 'flame_fallback', 0x00ffff);
            player = this.add.sprite(centerX, centerY, pKey);
            player.setDisplaySize(150, 150);

            // PARTICULAS
            let p = this.make.graphics().fillStyle(0xffffff).fillCircle(5,5,5);
            p.generateTexture('particle_dot', 10, 10);
            this.emitter = this.add.particles('particle_dot').createEmitter({
                speed: { min: 50, max: 150 },
                scale: { start: 0.8, end: 0 }, 
                blendMode: 'ADD',
                lifespan: 800,
                follow: player,
                tint: COL_NEUTRO
            });

            drawTrack(this);
            
            // RECTANGULO FLASH (Invisible por defecto)
            flashRect = this.add.rectangle(centerX, centerY, gameWidth, gameHeight, 0xffffff);
            flashRect.setAlpha(0);
            flashRect.setDepth(100); // Siempre encima

            this.time.addEvent({ delay: 1000, callback: onTimerTick, loop: true });

            this.input.on('pointerdown', (pointer) => {
                let testNames = ["Juan", "Maria", "Carlos", "Ana"];
                let randomName = testNames[Math.floor(Math.random() * testNames.length)];
                if(pointer.y < centerY) procesarInput(this, 'chat', 'angel', randomName);
                else procesarInput(this, 'chat', 'demon', randomName);
            });

            this.scale.on('resize', () => {
                updateDimensions(this);
                this.bg.setPosition(centerX, centerY);
                this.bg.setDisplaySize(Math.max(gameWidth, gameHeight * 1.2), Math.max(gameWidth, gameHeight * 1.2));
                
                // Actualizar flash rect
                flashRect.setPosition(centerX, centerY);
                flashRect.setSize(gameWidth, gameHeight);
                
                drawTrack(this);
            });

            conectarSocket(this);
        }

        function triggerFlash(scene) {
            flashRect.setAlpha(0.3); // Brillo sutil
            scene.tweens.add({
                targets: flashRect,
                alpha: 0,
                duration: 100 // Muy r치pido (100ms)
            });
        }

        function spawnFloatingName(scene, name, team) {
            let startX = player.x + (Math.random() - 0.5) * 80;
            let startY = player.y;
            let color = (team === "ANGEL") ? "#ffd700" : "#ff3300";
            let velocityY = (team === "ANGEL") ? -200 : 200;
            
            let text = scene.add.text(startX, startY, name, {
                fontFamily: 'Arial', fontSize: '20px', fontStyle: 'bold', color: color,
                stroke: "#000", strokeThickness: 3
            }).setOrigin(0.5);

            scene.tweens.add({
                targets: text,
                y: startY + velocityY,
                x: startX + (Math.random() - 0.5) * 50,
                alpha: 0,
                scale: 1.5,
                duration: 1200,
                onComplete: () => text.destroy()
            });
        }

        function updateDimensions(scene) {
            gameWidth = scene.scale.width;
            gameHeight = scene.scale.height;
            centerX = gameWidth / 2;
            centerY = gameHeight / 2;
            targetY = 100 + (currentPos / 100 * (gameHeight - 200));
        }

        function drawTrack(scene) {
            scene.trackBorder.clear(); scene.trackFill.clear();
            let trackH = gameHeight - 200; let trackY = 100;
            scene.trackBorder.fillStyle(0x444444, 0.5);
            scene.trackBorder.fillRoundedRect(centerX - 50, trackY - 10, 100, trackH + 20, 40);
            scene.trackFill.fillStyle(0x000000, 0.4);
            scene.trackFill.fillRoundedRect(centerX - 40, trackY, 80, trackH, 40);
            scene.trackLine.setPosition(centerX, centerY);
            scene.trackLine.width = 90;
        }
        
        function resize (gameSize, baseSize, displaySize, resolution) { updateDimensions(this); }
        function createFallbackTexture(scene, key, color) {
            let g = scene.make.graphics().fillStyle(color).fillRect(0,0,100,100);
            g.generateTexture(key, 100, 100); return key;
        }

        function update() {
            if (!gameActive) return;
            let trackH = gameHeight - 200;
            targetY = 100 + (currentPos / 100 * trackH);
            
            // === CAMBIO: LERP AUMENTADO A 0.3 (M치s r치pido/snappy) ===
            player.y = Phaser.Math.Linear(player.y, targetY, 0.3);
            player.x = centerX;

            if (currentPos < 40) { player.setTint(COL_ANGEL); this.emitter.setTint(COL_ANGEL); } 
            else if (currentPos > 60) { player.setTint(COL_DEMON); this.emitter.setTint(COL_DEMON); } 
            else { player.setTint(COL_NEUTRO); this.emitter.setTint(COL_NEUTRO); }

            let intensity = (Math.abs(currentPos - 50) / 50);
            let beatSpeed = 200 - (intensity * 100); 
            player.scaleX = (150/player.width) + Math.sin(this.time.now / beatSpeed) * (0.05 + intensity * 0.05);
        }

        function conectarSocket(scene) {
            // === CAMBIO: Forzar WebSockets para menos delay ===
            socket = io("https://tiktok-server-lmc9.onrender.com", {
                transports: ['websocket'], 
                upgrade: false
            });
            
            socket.on('connect', () => { document.getElementById('statusText').innerText = "EN VIVO - TURBO"; });
            socket.on('chat', (data) => procesarInput(scene, 'chat', data.comment, data.user));
            socket.on('like', (data) => procesarInput(scene, 'like', '', data.user));
            socket.on('gift', (data) => procesarInput(scene, 'gift', data.giftName, data.user));
        }

        function procesarInput(scene, tipo, texto, usuario) {
            if (!gameActive) return;
            let dir = 0; let fuerza = 0;
            let msg = String(texto).toLowerCase();
            let nombreUsuario = usuario || "Anonimo";
            let equipo = "";

            if (msg.includes('angel') || msg.includes('arriba')) { dir = -1; equipo = "ANGEL"; }
            else if (msg.includes('demon') || msg.includes('abajo')) { dir = 1; equipo = "DEMON"; }

            if (tipo === 'chat' && dir !== 0) fuerza = 2;
            else if (tipo === 'like') { 
                fuerza = 0.5; 
                if(Math.random()>0.5) { dir = -1; equipo = "ANGEL"; } else { dir = 1; equipo = "DEMON"; }
            }
            else if (tipo === 'gift') { 
                fuerza = 15; 
                if(Math.random()>0.5) { dir = -1; equipo = "ANGEL"; } else { dir = 1; equipo = "DEMON"; }
                reproducirSonido(scene, 'gift'); 
                scene.cameras.main.shake(300, 0.01);
            }

            if (dir !== 0) {
                currentPos += (fuerza * dir);
                if (currentPos < 0) currentPos = 0;
                if (currentPos > 100) currentPos = 100;
                
                if (!usuarios[nombreUsuario]) usuarios[nombreUsuario] = { puntos: 0, equipo: (dir === -1 ? "游땒" : "游땓") };
                usuarios[nombreUsuario].puntos += fuerza; 
                usuarios[nombreUsuario].equipo = (dir === -1 ? "游땒" : "游땓");

                if (tipo !== 'like') spawnFloatingName(scene, nombreUsuario, equipo);

                if (tipo !== 'gift' && Math.random() > 0.7) {
                    reproducirSonido(scene, 'hit');
                    // === NUEVO: Flashazo Visual ===
                    triggerFlash(scene);
                }
                chequearGanador(scene);
            }
        }

        function reproducirSonido(scene, key) { try { scene.sound.play(key); } catch(e) {} }

        function onTimerTick() {
            if (!gameActive) return;
            timeLeft--;
            document.getElementById('timerText').innerText = timeLeft;
            if (timeLeft <= 0) finalizarPartida("EMPATE", "neutral");
        }

        function chequearGanador(scene) {
            if (currentPos <= 0) finalizarPartida(scene, "GANA ANGEL", "angel");
            else if (currentPos >= 100) finalizarPartida(scene, "GANA DEMON", "demon");
        }

        function finalizarPartida(scene, texto, bando) {
            if(!gameActive) return;
            gameActive = false;

            if (bando === "angel") {
                totalWinsAngel++;
                document.getElementById('scoreAngel').innerText = totalWinsAngel;
            } else if (bando === "demon") {
                totalWinsDemon++;
                document.getElementById('scoreDemon').innerText = totalWinsDemon;
            }

            let ranking = Object.entries(usuarios).sort((a, b) => b[1].puntos - a[1].puntos).slice(0, 3);
            let mvpHtml = ranking.length === 0 ? "<div class='mvp-row'>Nadie puntu칩...</div>" : "";
            ranking.forEach((u, index) => {
                let medal = index === 0 ? "游볞" : (index === 1 ? "游볟" : "游볠");
                mvpHtml += `<div class='mvp-row'><span>${medal} ${u[0]}</span><span>${Math.floor(u[1].puntos)} pts</span></div>`;
            });
            document.getElementById('mvpList').innerHTML = mvpHtml;

            let screen = document.getElementById('winner-screen');
            let h1 = document.getElementById('winnerText');
            screen.style.display = 'flex'; screen.className = 'winner-screen';
            
            if (bando === "angel") { screen.classList.add('win-angel'); h1.innerText = texto; reproducirSonido(scene, 'winA'); }
            else if (bando === "demon") { screen.classList.add('win-demon'); h1.innerText = texto; reproducirSonido(scene, 'winD'); }
            else { h1.innerText = "EMPATE"; h1.style.color = "white"; }

            let count = 10;
            let counterSpan = document.getElementById('restartCount');
            counterSpan.innerText = count;
            let int = setInterval(() => {
                count--;
                counterSpan.innerText = count;
                if (count <= 0) { clearInterval(int); softResetGame(); }
            }, 1000);
        }

        function softResetGame() {
            gameActive = true; timeLeft = 240; currentPos = 50; usuarios = {}; 
            document.getElementById('timerText').innerText = timeLeft;
            document.getElementById('winner-screen').style.display = 'none';
            document.getElementById('mvpList').innerHTML = "";
            if(player) {
                player.y = centerY;
                player.setTint(COL_NEUTRO);
            }
        }
    </script>
</body>
</html>
